name: Build and Deploy Go BFF
description: |
  This workflow deploys a personal website using GitHub Actions. It includes a CodeQL security scan, builds the React application, and deploys it to GitHub Pages.

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

on:
  # Runs on pushes targeting the main branch
  push:
    branches:
      - main
      
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  security-events: write
  packages: write

jobs:
  go:
    uses: malcolmdzimati/workflow-templates/.github/workflows/codeql_security_scan_job.yml@main
    with:
        language: 'Go'

  go-api:
    uses: malcolmdzimati/workflow-templates/.github/workflows/build_test_go_job.yml@main
    needs: go # Ensures the build only runs if the CodeQL scan passes
    with:
        app-name: 'PropertyToolsByRotaBackend'
        working-directory: './PropertyToolsByRotaBackend'

  go-docker:
    uses: malcolmdzimati/workflow-templates/.github/workflows/docker_job.yml@main
    with:
        app-name: 'propertytoolsbyrotabackend'
        registry-username: 'malcolmdzimati'
        dockerfile-path: './PropertyToolsByRotaBackend/Dockerfile'
    needs: go-api # Ensures the build only runs if the CodeQL scan passes

  go-containerapp:
    uses: malcolmdzimati/workflow-templates/.github/workflows/deploy_container_fly_job.yml@main
    needs: go-docker # Ensures the build only runs if the CodeQL scan passes
    with:
        app-name: 'propertytoolsbyrota/propertytoolsbyrotabackend'
        registry-username: 'malcolmdzimati'
    secrets:
      fly_api_token: ${{ secrets.FLY_API_TOKEN }}